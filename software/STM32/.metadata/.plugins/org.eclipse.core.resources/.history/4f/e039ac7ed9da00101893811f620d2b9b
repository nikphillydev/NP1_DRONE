/*
 * radio.cpp
 *
 *  Created on: May 28, 2025
 *      Author: Nikolai Philipenko
 */
#include "Threads/radio.hpp"
#include "main.h"
#include "spi.h"
#include "gpio.h"
#include "Drivers/CC2500.hpp"
#include "Drivers/usb.hpp"
#include <cstring>
#include <cstdio>

#define IS_RECEIVER					false

#define PACKET_LENGTH				15
#define CC2500_RF_ADDRESS			0x69

CC2500 modem(&hspi1, spi1MutexHandle, CC2500_CS_GPIO_Port, CC2500_CS_Pin, cc2500StatusMutexHandle, PACKET_LENGTH, CC2500_RF_ADDRESS);

bool interrupt_enabled = false;

/*
 *
 * THREADS
 *
 */
void radio_thread()
{
	osDelay(400);
	USB_Log("--- RADIO THREAD STARTING ---", CRITICAL);
	osDelay(100);

	// Initialize 2.4GHz RF modem
	bool modem_init = modem.init();

	// Re-enable RX interrupt; CC2500 fully initialized
	GPIO_Enable_EXTI0_IRQn();
	interrupt_enabled = true;

	modem_init = false;

	if (modem_init)
	{
		if (IS_RECEIVER)
		{
			// Enter receive mode
			if (!modem.enter_rx_mode())
			{
				USB_Log("CC2500 failed to enter RX mode", ERR);
			}
		}
		else
		{
			// Enter transmit mode
			if (!modem.enter_tx_mode())
			{
				USB_Log("CC2500 failed to enter TX mode", ERR);
			}
		}
		while (1)
		{
			if (IS_RECEIVER)
			{
				// RX handled by interrupts
				osDelay(5000);
				USB_Log("CC2500 waiting for message...", INFO);
			}
			else
			{
				uint8_t tx_data[PACKET_LENGTH];
				for (int i = 0; i < PACKET_LENGTH; i++)
				{
					tx_data[i] = i + 1;
				}

				USB_Log("CC2500 transmitting...", INFO);
				if (!modem.transmit_packet(tx_data))
				{
					USB_Log("CC2500 failed to transmit message", ERR);
				}
				osDelay(50);
			}
		}
	}
	else
	{
		USB_Log("RADIO THREAD: Failed to initialize radio modem.", ERR);
		osDelay(10);
		vTaskDelete( NULL );
	}
}

/*
 *
 * FUNCTIONS
 *
 */
void service_CC2500_receive_irq()
{
	if (interrupt_enabled && IS_RECEIVER)
	{
		uint8_t rx_buffer[128];
		memset(rx_buffer, 0, sizeof(rx_buffer));

		uint8_t num_bytes = modem.receive_packet(rx_buffer);
		if (num_bytes)
		{
			char output[128];
			int offset = sprintf(output, "MESSAGE RECEIVED: ");
			for (int i = 0; i < num_bytes; i++)
			{
				offset += sprintf(output + offset, "%X ", rx_buffer[i]);
			}
			USB_Log(output, INFO);
		}
	}
}


